<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Linha da Vida</title>
  <style>
    :root{--bg:#f7f7f8;--card:#ffffff;--text:#111827;--muted:#6b7280;--accent:#4f46e5;--positive:#10b981;--difficult:#ef4444;--radius:12px}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);padding:20px}
    .container{max-width:980px;margin:0 auto;display:grid;gap:16px}
    .header{background:var(--card);padding:14px;border-radius:14px;border:1px solid #e6e7eb}
    .header h1{margin:0;font-size:1.2rem}
    .header p{margin:6px 0 0;color:var(--muted);font-size:0.92rem}
    .layout{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:820px){.layout{grid-template-columns:1fr}}
    .card{background:var(--card);padding:14px;border-radius:12px;border:1px solid #e6e7eb}
    form{display:grid;gap:10px}
    label{font-weight:600;font-size:0.9rem}
    input,textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e7eb;background:#fbfbfb;font-size:0.95rem}
    textarea{min-height:88px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){.row{grid-template-columns:1fr}}
    .buttons{display:flex;gap:8px;flex-wrap:wrap}
    button{padding:8px 12px;border-radius:999px;border:0;font-weight:600;cursor:pointer}
    .primary{background:var(--accent);color:white}
    .secondary{background:#f3f4f6;color:var(--text);border:1px solid #e6e7eb}
    .danger{background:white;color:var(--difficult);border:1px solid #fdecea}
    .timeline-wrapper{max-height:420px;overflow:auto;padding-right:6px}
    .empty{padding:12px;border-radius:8px;background:#fafafa;border:1px dashed #e9e9ea;color:var(--muted)}
    .timeline{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:10px}
    .item{display:flex;gap:12px;align-items:flex-start;padding:10px;border-radius:10px;background:#fff;border:1px solid #f0f0f2}
    .item.dragging{opacity:0.5}
    .item.over{box-shadow:inset 0 0 0 2px rgba(79,70,229,0.08)}
    .dot{width:12px;height:12px;border-radius:50%}
    .dot.pos{background:var(--positive)}
    .dot.neu{background:#9ca3af}
    .dot.neg{background:var(--difficult)}
    .content{flex:1}
    .meta{display:flex;justify-content:space-between;gap:12px;align-items:center;margin-top:6px}
    .small{font-size:0.82rem;color:var(--muted)}
    .actions{display:flex;gap:8px}
    .actions button{padding:6px 10px;font-size:0.82rem}
    button:focus,input:focus,textarea:focus{outline:2px solid rgba(79,70,229,0.08)}

    /* Footer styles */
    .site-footer{
      margin-top:28px;
      padding:10px 0;
      text-align:center;
      opacity:0.55;
      font-size:0.7rem;
      line-height:1.2;
    }
    .site-footer .footer-line{color:var(--muted);}
    .site-footer a{color:var(--muted);text-decoration:none;}
    .site-footer a:hover{text-decoration:underline;}
    .site-footer .author{font-weight:600;}
    .site-footer a{color:var(--muted);text-decoration:none;font-weight:500;}
    .site-footer a:hover{text-decoration:underline;}
    .site-footer .meta, .site-footer .legal{color:var(--muted);}
    .site-footer .author{font-weight:700}
    .site-footer .meta{font-size:0.92rem;color:var(--muted)}
    .site-footer .legal{font-size:0.78rem;color:var(--muted);text-align:center;max-width:820px}
    @media (min-width:821px){ .site-footer{flex-direction:row;justify-content:space-between;align-items:center} .site-footer .block{flex:1} }
  </style>
</head>
<body>
  <div class="container">
    <header class="header" aria-label="Linha da Vida – cabeçalho">
      <h1>Linha da Vida</h1>
      <p>Mantenha a privacidade e o ritmo clínico. Dados ficam apenas no navegador.</p>
    </header>

    <section class="layout" aria-label="Área principal">
      <div class="card" aria-label="Formulário de evento">
        <h2>Novo evento</h2>
        <form id="form">
          <div class="row">
            <div>
              <label for="age">Idade / Ano *</label>
              <input id="age" name="age" placeholder="Ex.: 7 anos, 2012" required />
            </div>
            <div>
              <label for="val">Valência</label>
              <select id="val" name="val">
                <option value="positivo">Positivo</option>
                <option value="neutro">Neutro</option>
                <option value="dificil">Difícil</option>
              </select>
            </div>
          </div>

          <div>
            <label for="title">Título (opcional)</label>
            <input id="title" name="title" placeholder="Ex.: Mudança de casa" />
          </div>

          <div>
            <label for="desc">Descrição</label>
            <textarea id="desc" name="desc" placeholder="Descreva brevemente a experiência..."></textarea>
          </div>

          <div class="buttons">
            <button type="submit" class="primary" id="submit">Adicionar</button>
            <button type="button" class="secondary" id="clear">Limpar</button>
          </div>
          <p class="small" style="margin-top:8px">Dica: evite dados identificáveis. Use em sessão com consentimento.</p>
        </form>
      </div>

      <div class="card" aria-label="Linha da vida">
        <h2>Linha da vida <span id="count" style="font-weight:600">(0)</span></h2>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="small">Arraste os eventos para reorganizar</div>
          <div><button id="clearAll" class="danger">Limpar tudo</button></div>
        </div>

        <div class="timeline-wrapper">
          <div id="empty" class="empty">Nenhum evento registrado. Adicione um momento importante.</div>
          <ul id="list" class="timeline" aria-live="polite"></ul>
        </div>

        <p class="small" style="margin-top:10px">Recurso de apoio — não substitui avaliação ou terapia.</p>
      </div>
    </section>

    <!-- Footer -->
    <footer class="site-footer" role="contentinfo" aria-label="Rodapé do site">
      <div class="footer-line">
        Gabriel Vinícius – Psicólogo • CRP 06/215890 • PsicoQuest • 
        <a href="https://gabrielopsicologo.com/psicoquest" target="_blank" rel="noopener noreferrer">gabrielopsicologo.com/psicoquest</a> • © 2025
      </div>
    </footer>

  </div>

  <script>
    (function(){
      const KEY = 'linhaVidaDnd_v1';
      let events = [];
      const form = document.getElementById('form');
      const age = document.getElementById('age');
      const val = document.getElementById('val');
      const title = document.getElementById('title');
      const desc = document.getElementById('desc');
      const list = document.getElementById('list');
      const empty = document.getElementById('empty');
      const count = document.getElementById('count');
      const clearBtn = document.getElementById('clear');
      const clearAllBtn = document.getElementById('clearAll');

      function load(){
        try{const raw=localStorage.getItem(KEY); if(raw) events=JSON.parse(raw)}catch(e){console.warn(e)}
      }
      function save(){ try{localStorage.setItem(KEY,JSON.stringify(events))}catch(e){console.warn(e)} }

      function arrayMove(arr, fromIndex, toIndex){
        const newArr = arr.slice();
        const [item] = newArr.splice(fromIndex,1);
        newArr.splice(toIndex,0,item);
        return newArr;
      }

      function escapeHtml(str){ return String(str).replace(/[&<>\"'`]/g, function(s){return {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;','`':'&#96;'}[s];}); }

      function render(){
        list.innerHTML='';
        if(!events.length){ empty.style.display='block'; count.textContent='(0)'; return }
        empty.style.display='none';
        count.textContent='('+events.length+')';

        events.forEach(function(ev, index){
          const li = document.createElement('li');
          li.className = 'item';
          li.draggable = true;
          li.setAttribute('data-id', ev.id);
          li.setAttribute('data-index', index);

          // drag events
          li.addEventListener('dragstart', function(e){
            li.classList.add('dragging');
            try{ e.dataTransfer.setData('text/plain', ev.id); e.dataTransfer.effectAllowed = 'move'; }catch(err){}
          });
          li.addEventListener('dragend', function(){ li.classList.remove('dragging'); document.querySelectorAll('.item.over').forEach(function(x){x.classList.remove('over');}); });

          li.addEventListener('dragover', function(e){ e.preventDefault(); li.classList.add('over'); e.dataTransfer.dropEffect = 'move'; });
          li.addEventListener('dragleave', function(){ li.classList.remove('over'); });

          li.addEventListener('drop', function(e){
            e.preventDefault(); li.classList.remove('over');
            const draggedId = e.dataTransfer.getData('text/plain');
            if(!draggedId || draggedId === ev.id) return;
            const fromIndex = events.findIndex(function(x){return x.id===draggedId});
            const toIndex = events.findIndex(function(x){return x.id===ev.id});
            if(fromIndex<0||toIndex<0) return;
            events = arrayMove(events, fromIndex, toIndex);
            save(); render();
          });

          const dot = document.createElement('div'); dot.className = 'dot ' + (ev.val==='positivo'? 'pos' : ev.val==='dificil'? 'neg' : 'neu');
          const c = document.createElement('div'); c.className = 'content';
          c.innerHTML = '<div style="font-weight:600">' + (ev.age||'—') + ' • ' + (ev.title||'') + '</div>' + (ev.desc? '<div class="small" style="margin-top:6px">'+ escapeHtml(ev.desc) +'</div>' : '');

          const meta = document.createElement('div'); meta.className = 'meta';
          const time = document.createElement('div'); time.className = 'small'; time.textContent = new Date(ev.created).toLocaleString();
          const actions = document.createElement('div'); actions.className = 'actions';

          const editBtn = document.createElement('button'); editBtn.className = 'secondary'; editBtn.textContent = 'Editar';
          editBtn.addEventListener('click', function(){ age.value = ev.age; val.value = ev.val; title.value = ev.title; desc.value = ev.desc; editing = ev.id; submit.textContent = 'Salvar'; age.focus(); });

          const delBtn = document.createElement('button'); delBtn.className = 'danger'; delBtn.textContent = 'Excluir';
          delBtn.addEventListener('click', function(){ if(!confirm('Remover este evento?')) return; events = events.filter(function(x){return x.id!==ev.id}); save(); render(); });

          actions.appendChild(editBtn); actions.appendChild(delBtn);
          meta.appendChild(time); meta.appendChild(actions);
          c.appendChild(meta);

          li.appendChild(dot); li.appendChild(c); list.appendChild(li);
        });
      }

      let editing = null;
      const submit = document.getElementById('submit');

      form.addEventListener('submit', function(e){
        e.preventDefault();
        const payload = { age: age.value.trim(), val: val.value, title: title.value.trim(), desc: desc.value.trim(), created: new Date().toISOString() };
        if(!payload.age) return age.focus();
        if(editing){ var idx = events.findIndex(function(x){return x.id===editing}); if(idx>-1){ events[idx] = Object.assign(events[idx], payload); editing = null; submit.textContent = 'Adicionar'; } }
        else{ payload.id = 'e_' + Date.now() + '_' + Math.random().toString(36).slice(2,7); events.push(payload); }
        form.reset(); save(); render();
      });

      clearBtn.addEventListener('click', function(){ form.reset(); editing = null; submit.textContent = 'Adicionar'; age.focus(); });
      clearAllBtn.addEventListener('click', function(){ if(!events.length) return; if(confirm('Apagar TODOS os eventos?')){ events = []; save(); render(); } });

      // initialize
      load(); render();

      // additional touch: support reordering via long-press on touch devices (fallback)
      (function touchReorderFallback(){
        let touchSrcId = null;
        let startY = 0;
        list.addEventListener('touchstart', function(e){
          const li = e.target.closest('.item');
          if(!li) return;
          touchSrcId = li.getAttribute('data-id');
          startY = e.touches[0].clientY;
        }, {passive:true});

        list.addEventListener('touchend', function(e){
          if(!touchSrcId) return;
          const li = e.target.closest('.item');
          if(!li) { touchSrcId = null; return; }
          const endY = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0].clientY : startY;
          if(Math.abs(endY - startY) < 8){ touchSrcId = null; return; } // treat as tap
          // find nearest item under touch end
          const elements = Array.from(list.querySelectorAll('.item'));
          const targetIndex = elements.indexOf(li);
          const fromIndex = events.findIndex(function(x){return x.id===touchSrcId});
          if(fromIndex>=0 && targetIndex>=0 && fromIndex!==targetIndex){ events = arrayMove(events, fromIndex, targetIndex); save(); render(); }
          touchSrcId = null;
        }, {passive:true});
      })();

    })();
  </script>
</body>
