<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grande Rota das Emoções</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Inter:wght@400;600;800&family=Lora:wght@400;600&display=swap" rel="stylesheet">
    

    <style>
        :root {
            --cor-madeira: #3e2723;
            --cor-ouro: #c8a464;
            --cor-texto: #4a2c2a;
        }

        /* ANIMAÇÕES */
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes island-pop { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes ship-bob { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-5px) rotate(2deg); } }

        body {
            font-family: 'Inter', sans-serif;
            /* Fundo One Piece */
            background-image: url('https://cdn.jsdelivr.net/gh/gabriel20402/Jogos-terapeuticos@main/Background_OP.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            color: var(--cor-texto);
        }

        .font-cinzel { font-family: 'Cinzel', serif; }
        .animate-fade-in { animation: fade-in-up 0.6s ease-out forwards; }

        /* BARCO ANIMADO */
        #pirate-ship {
            position: fixed;
            z-index: 100;
            pointer-events: none;
            transition: left 1.5s cubic-bezier(0.45, 0, 0.55, 1), top 1.5s cubic-bezier(0.45, 0, 0.55, 1), opacity 0.3s ease;
            opacity: 0;
            width: 64px;
            height: 64px;
            /* Centraliza o ponto de transformação */
            transform: translate(-50%, -50%); 
        }
        
        .ship-visible {
            opacity: 1 !important;
        }

        .ship-icon {
            width: 100%;
            height: 100%;
            color: #8c1c13; /* Vermelho do Sunny */
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
            animation: ship-bob 1s infinite ease-in-out;
        }

        /* ESTILO DOS CARDS DAS ILHAS */
        .island-card {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 2px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(4px);
        }
        .island-card:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
            border-color: #ffd700;
            z-index: 10;
        }
        .island-card:active { transform: scale(0.95); }

        /* ÁREA DE CONTEÚDO */
        .glass-panel {
            background: rgba(255, 248, 225, 0.95); /* Papel antigo */
            border: 4px double var(--cor-madeira);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        /* RODAPÉ ESTÁTICO */
        .static-footer {
            width: 100%;
            background: linear-gradient(to top, rgba(20, 10, 5, 0.95) 0%, rgba(20, 10, 5, 0.8) 100%);
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            padding: 1.5rem 1rem;
            margin-top: auto;
            z-index: 20;
            font-size: 0.75rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            border-top: 1px solid rgba(200, 164, 100, 0.3);
        }
        
        @media (min-width: 768px) { .static-footer { font-size: 0.85rem; padding: 2rem 1rem; } }

        .footer-link { color: #fbbf24; font-weight: 600; text-decoration: none; transition: 0.3s; }
        .footer-link:hover { color: white; text-decoration: underline; }

        input:focus, textarea:focus {
            outline: none;
            border-color: #c8a464;
            box-shadow: 0 0 0 3px rgba(200, 164, 100, 0.3);
        }
    </style>
</head>
<body>

    <div id="pirate-ship">
        <i data-lucide="ship" class="ship-icon"></i>
    </div>

    <header class="w-full bg-[#3e2723]/95 backdrop-blur-md text-[#ffecb3] shadow-xl p-4 flex justify-between items-center fixed top-0 z-30 border-b-2 border-[#c8a464]">
        <h1 class="text-lg md:text-2xl font-black tracking-wider flex items-center gap-2 font-cinzel">
            <i data-lucide="compass" class="w-6 h-6 text-yellow-500"></i> Grande Rota das Emoções
        </h1>
        <div id="auth-info" class="text-xs md:text-sm opacity-90 text-right bg-[#5d4037] px-3 py-1 rounded-lg border border-[#c8a464]/50 text-white"></div>
    </header>

    <div class="pt-24 pb-10 px-4 flex-grow w-full max-w-6xl mx-auto flex flex-col justify-center">
        <main id="content" class="w-full">
            <div id="loading" class="text-center p-8 text-white font-bold bg-black/50 rounded-lg backdrop-blur-sm inline-block mx-auto border border-[#c8a464]"> 
                <i data-lucide="loader-circle" class="w-8 h-8 mx-auto animate-spin mb-2 text-yellow-500"></i>
                <p>Içando as velas...</p>
            </div>
        </main>
    </div>

    <footer class="static-footer font-cinzel">
        <div class="max-w-4xl mx-auto flex flex-col items-center justify-center gap-3">
            <a href="https://www.instagram.com/gabrielopsicologo" target="_blank" class="hover:scale-105 transition-transform duration-300">
                <img src="https://cdn.jsdelivr.net/gh/gabriel20402/Jogos-terapeuticos@main/Logo_branca.png" alt="Logo Gabriel Psicólogo" class="h-10 md:h-12 opacity-70 hover:opacity-100 transition-opacity duration-300 drop-shadow-sm">
            </a>

            <div class="flex flex-col md:flex-row items-center justify-center gap-1 md:gap-4 leading-tight">
                <p>Desenvolvido por <a href="https://www.instagram.com/gabrielopsicologo" target="_blank" class="footer-link">@gabrielopsicologo</a></p>
                <span class="hidden md:inline opacity-50">|</span>
                <p>Gabriel Vinicius dos Santos Fernandes Vasconcelos - CRP 06/215890</p>
            </div>
            <div class="mt-1 opacity-50 font-sans text-[0.65rem] md:text-xs">
                &copy; 2025 Todos os direitos reservados.
            </div>
        </div>
    </footer>

    <a href="https://wa.me/message/WV34TWMSKTEEL1" target="_blank" class="fixed bottom-24 md:bottom-28 right-4 md:right-6 z-40 bg-[#128C7E] text-white p-3 md:p-4 rounded-full shadow-xl hover:bg-[#075E54] transition-colors animate-float-slow animate-bounce shadow-lg border-2 border-white">
        <i data-lucide="message-circle" class="w-6 h-6 md:w-7 md:h-7"></i>
    </a>

    <div id="instructionsModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-opacity" onclick="window.hideInstructionsModal()">
        <div class="bg-[#fff8e1] rounded-xl shadow-2xl p-6 max-w-lg w-full transform transition-all scale-100 border-4 double border-[#3e2723]" onclick="event.stopPropagation()">
            <div class="flex items-center border-b border-[#3e2723]/20 pb-3 mb-4">
                 <i data-lucide="scroll" class="w-6 h-6 text-[#3e2723] mr-3"></i>
                 <h3 class="text-xl font-bold text-[#3e2723] font-cinzel">Código do Navegador</h3> 
            </div>
            <ul class="space-y-3 text-[#4a2c2a] text-sm md:text-base list-none font-serif"> 
                <li class="flex gap-2"><i data-lucide="lock" class="w-5 h-5 text-yellow-700 shrink-0"></i> <span><strong>Sigilo:</strong> Os registros ficam salvos apenas no seu Log Pose (neste dispositivo).</span></li>
                <li class="flex gap-2"><i data-lucide="map" class="w-5 h-5 text-yellow-700 shrink-0"></i> <span><strong>Exploração:</strong> Use para mapear as correntes emocionais do paciente.</span></li>
            </ul>
            <div class="mt-6 text-right">
                <button onclick="window.hideInstructionsModal()" class="bg-[#3e2723] text-[#ffecb3] font-bold py-2 px-6 rounded-lg hover:bg-[#5d4037] transition shadow-md border border-[#c8a464]">
                    Entendi
                </button>
            </div>
        </div>
    </div>
    
    <div id="image-export-container" style="position: absolute; left: -9999px; top: -9999px;"></div>

    <script type="module">
        let selectedPatientName = localStorage.getItem('lastPatientName') || null; 
        let localSessions = [];
        let currentPage = selectedPatientName ? 'map' : 'login';
        let currentEmotion = null;

        const EMOTIONS = {
            ALEGRIA: {
                name: "Alegria (Enseada Radiante)", color: "bg-yellow-500 hover:bg-yellow-600", textColor: "text-yellow-700", icon: "sun",
                questions: [ { id: "s-alegria", q: "Qual tesouro você encontrou hoje?" }, { id: "t-alegria", q: "O que você pensou ao celebrar?" }, { id: "b-alegria", q: "Como você festejou esse momento?" }, { id: "a-alegria", q: "Como navegar para cá mais vezes?" } ]
            },
            TRISTEZA: {
                name: "Tristeza (Gruta Solitária)", color: "bg-blue-700 hover:bg-blue-800", textColor: "text-blue-800", icon: "cloud-rain",
                questions: [ { id: "s-tristeza", q: "Que tempestade atingiu seu navio?" }, { id: "t-tristeza", q: "Quais pensamentos pesaram na âncora?" }, { id: "b-tristeza", q: "Você recolheu as velas (se isolou)?" }, { id: "a-tristeza", q: "O que pode consertar o casco agora?" } ]
            },
            RAIVA: {
                name: "Raiva (Vulcão da Fúria)", color: "bg-red-700 hover:bg-red-800", textColor: "text-red-800", icon: "flame",
                questions: [ { id: "s-raiva", q: "Quem invadiu seu território?" }, { id: "t-raiva", q: "Qual pensamento ferveu como lava?" }, { id: "b-raiva", q: "Teve vontade de disparar os canhões?" }, { id: "a-raiva", q: "Como defender o navio sem afundar o outro?" } ]
            },
            MEDO: {
                name: "Medo (Floresta das Sombras)", color: "bg-indigo-800 hover:bg-indigo-900", textColor: "text-indigo-900", icon: "eye-off",
                questions: [ { id: "s-medo", q: "Qual monstro marinho apareceu?" }, { id: "t-medo", q: "Qual foi a previsão de naufrágio?" }, { id: "b-medo", q: "Você mudou a rota para fugir?" }, { id: "a-medo", q: "O monstro é real ou ilusão da neblina?" } ]
            },
            NOJO: {
                name: "Nojo (Pântano da Repulsa)", color: "bg-green-700 hover:bg-green-800", textColor: "text-green-800", icon: "skull",
                questions: [ { id: "s-nojo", q: "O que cheirou mal no convés?" }, { id: "t-nojo", q: "O que você pensou sobre isso?" }, { id: "b-nojo", q: "Você fez cara feia ou se afastou?" }, { id: "a-nojo", q: "Isso é veneno ou apenas algo diferente?" } ]
            },
            SURPRESA: {
                name: "Surpresa (Céu de Skypiea)", color: "bg-sky-500 hover:bg-sky-600", textColor: "text-sky-700", icon: "zap",
                questions: [ { id: "s-surpresa", q: "O que caiu do céu de repente?" }, { id: "t-surpresa", q: "Foi um baú de ouro ou uma bomba?" }, { id: "b-surpresa", q: "Seu corpo paralisou ou pulou?" }, { id: "a-surpresa", q: "Como ajustar as velas para isso?" } ]
            },
            DESPREZO: {
                name: "Desprezo (Torre da Arrogância)", color: "bg-gray-600 hover:bg-gray-700", textColor: "text-gray-800", icon: "thumbs-down",
                questions: [ { id: "s-desprezo", q: "Quem você olhou de cima do mastro?" }, { id: "t-desprezo", q: "Qual julgamento você fez?" }, { id: "b-desprezo", q: "Você ignorou ou foi sarcástico?" }, { id: "a-desprezo", q: "Isso ajuda a tripulação ou cria motim?" } ]
            }
        };
        
        setTimeout(renderApp, 100); 

        // --- FUNÇÃO DE NAVEGAÇÃO (ANIMAÇÃO DO BARCO) ---
        window.sailToIsland = function(emotionKey, event) {
            const button = event.currentTarget;
            const ship = document.getElementById('pirate-ship');
            
            // Pega a posição do botão clicado
            const rect = button.getBoundingClientRect();
            
            // Calcula o centro do botão
            const targetX = rect.left + (rect.width / 2);
            const targetY = rect.top + (rect.height / 2);
            
            // Define a posição inicial do barco (centro da tela, ou posição anterior)
            // Para simplificar, vamos fazê-lo sair do rodapé da tela (posição fixa inicial)
            ship.style.left = '50%';
            ship.style.top = '100%';
            ship.style.transition = 'none'; // Remove transição para resetar posição
            
            // Força o reflow para aplicar o reset
            void ship.offsetWidth;
            
            // Torna o barco visível
            ship.classList.add('ship-visible');
            ship.style.transition = 'left 1.2s ease-in-out, top 1.2s ease-in-out'; // Reativa transição
            
            // Move o barco para a ilha
            requestAnimationFrame(() => {
                ship.style.left = `${targetX}px`;
                ship.style.top = `${targetY}px`;
            });
            
            // Espera a animação terminar antes de abrir a página
            setTimeout(() => {
                ship.classList.remove('ship-visible');
                renderIsland(emotionKey);
            }, 1200); // Tempo deve bater com a transição CSS
        };

        async function saveSession() {
            if (!selectedPatientName) { displayMessage("Identifique o pirata!", 'bg-red-700'); return; }
            const form = document.getElementById('emotion-form');
            const answers = {};
            let isComplete = true;
            EMOTIONS[currentEmotion].questions.forEach(q => {
                const input = form.querySelector(`#${q.id}`);
                const value = input ? input.value.trim() : '';
                answers[q.id] = value;
                if (!value) isComplete = false;
            });
            if (!isComplete) { displayMessage("O diário de bordo está incompleto!", 'bg-yellow-600'); return; }
            const newSession = {
                patientName: selectedPatientName, emotion: currentEmotion, emotionName: EMOTIONS[currentEmotion].name, answers: answers, timestamp: new Date().toISOString()
            };
            const currentSavedSessions = JSON.parse(localStorage.getItem(`localSessions_${selectedPatientName}`)) || [];
            currentSavedSessions.push(newSession);
            localStorage.setItem(`localSessions_${selectedPatientName}`, JSON.stringify(currentSavedSessions));
            localSessions = currentSavedSessions;
            displayMessage("Registro salvo no Log Pose!", 'bg-green-700');
            renderMap();
        }

        function displayMessage(text, bgColor) {
            const messageBox = document.createElement('div');
            messageBox.className = `${bgColor} text-white p-4 rounded-lg shadow-xl mb-4 text-center fixed top-20 left-1/2 transform -translate-x-1/2 z-50 font-bold animate-fade-in border-2 border-[#c8a464] font-cinzel`;
            messageBox.innerHTML = `<div class="flex items-center gap-2"><i data-lucide="anchor" class="w-5 h-5"></i> ${text}</div>`;
            document.body.appendChild(messageBox);
            lucide.createIcons();
            setTimeout(() => { messageBox.remove(); }, 3000);
        }

        function renderApp() {
            document.getElementById('loading')?.remove();
            if (!selectedPatientName) currentPage = 'login';
            else if (currentPage === 'login' && selectedPatientName) currentPage = 'map';
            updateAuthInfo();
            if (selectedPatientName) localSessions = JSON.parse(localStorage.getItem(`localSessions_${selectedPatientName}`)) || [];
            if (currentPage === 'login') renderPatientSelector();
            else if (currentPage === 'map') renderMap();
            else if (currentPage === 'island' && currentEmotion) renderIsland(currentEmotion);
            lucide.createIcons();
        }
        
        function updateAuthInfo() {
            const authInfoDiv = document.getElementById('auth-info');
            if (selectedPatientName) {
                authInfoDiv.innerHTML = `<span class="opacity-70 text-xs mr-1 font-serif">Navegador:</span> <strong class="text-[#ffecb3]">${selectedPatientName}</strong>`;
            } else {
                authInfoDiv.innerHTML = `<span>Porto Seguro</span>`;
            }
        }

        function renderPatientSelector() {
            currentPage = 'login';
            selectedPatientName = null;
            localSessions = []; 
            localStorage.removeItem('lastPatientName'); 
            updateAuthInfo();
            document.getElementById('content').innerHTML = `
                <div class="glass-panel p-8 rounded-xl shadow-2xl max-w-md mx-auto text-center animate-fade-in">
                    <div class="bg-[#3e2723] p-4 rounded-full inline-block mb-4 border-2 border-[#c8a464]">
                        <i data-lucide="skull" class="w-10 h-10 text-[#ffecb3]"></i>
                    </div>
                    <h2 class="text-2xl font-extrabold text-[#3e2723] mb-2 font-cinzel">Quem Navega?</h2>
                    <p class="text-[#5d4037] mb-6 text-sm font-serif">Identifique o tripulante para acessar o Log Pose.</p> 
                    <form onsubmit="event.preventDefault(); window.setPatient()">
                        <div class="mb-4 text-left">
                            <input type="text" id="patientNameInput" class="w-full p-3 mt-1 border-2 border-[#c8a464] rounded-lg bg-[#fff8e1] text-[#3e2723] placeholder-[#8d6e63]" placeholder="Nome do Pirata" required> 
                        </div>
                        <button type="submit" class="w-full bg-[#8c1c13] hover:bg-[#b71c1c] text-white font-bold py-3 px-4 rounded-xl shadow-lg transition flex items-center justify-center gap-2 border border-[#ffecb3]">
                            <span>Içar Velas</span> <i data-lucide="ship" class="w-5 h-5"></i>
                        </button>
                    </form>
                    <button onclick="window.showInstructionsModal()" class="mt-6 text-xs text-[#5d4037] hover:text-[#3e2723] underline flex items-center justify-center mx-auto gap-1 font-serif">
                        <i data-lucide="scroll" class="w-3 h-3"></i> Pergaminho de Regras
                    </button>
                </div>`;
            lucide.createIcons();
        }

        window.setPatient = function() {
            const input = document.getElementById('patientNameInput');
            const name = input.value.trim();
            if (name) {
                selectedPatientName = name;
                localStorage.setItem('lastPatientName', name);
                currentPage = 'map'; 
                renderApp();
            }
        }

        function renderMap() {
            currentPage = 'map';
            currentEmotion = null;
            const islandButtonsHtml = Object.entries(EMOTIONS).map(([key, emotion], index) => {
                const nameParts = emotion.name.split('(');
                // Alterado onclick para chamar sailToIsland
                return `
                    <button onclick="window.sailToIsland('${key}', event)" class="island-card ${emotion.color} text-white p-5 rounded-2xl shadow-lg flex flex-col items-center justify-center text-center relative overflow-hidden group h-32 md:h-40" style="animation: island-pop 0.5s ease-out ${index * 0.1}s backwards">
                        <div class="absolute inset-0 bg-black/10 opacity-0 group-hover:opacity-20 transition-opacity"></div>
                        <i data-lucide="${emotion.icon}" class="w-8 h-8 md:w-10 md:h-10 mb-2 drop-shadow-md"></i>
                        <span class="text-base md:text-lg font-bold leading-tight drop-shadow font-cinzel">${nameParts[0].trim()}</span>
                        <span class="text-[10px] md:text-xs opacity-90 mt-1 font-medium bg-black/20 px-2 py-0.5 rounded-full">${nameParts[1] ? nameParts[1].replace(')', '') : ''}</span> 
                    </button>
                `;
            }).join('');

            document.getElementById('content').innerHTML = `
                <div class="space-y-6 animate-fade-in">
                    <div class="glass-panel rounded-2xl shadow-2xl p-6 sm:p-8 relative overflow-hidden">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h2 class="text-2xl md:text-3xl font-black text-[#3e2723] flex items-center gap-2 font-cinzel">
                                    <i data-lucide="map" class="w-8 h-8 text-[#8c1c13]"></i> Grande Rota
                                </h2>
                                <p class="text-[#5d4037] mt-1 font-serif">Escolha uma ilha para atracar.</p>
                            </div>
                            <button onclick="window.renderPatientSelector()" class="text-xs bg-[#5d4037] hover:bg-[#3e2723] text-[#ffecb3] px-3 py-2 rounded-lg flex items-center gap-1 transition border border-[#c8a464]">
                                <i data-lucide="log-out" class="w-3 h-3"></i> Sair
                            </button>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            ${islandButtonsHtml}
                        </div>
                    </div>
                    <div class="bg-[#fff8e1]/90 backdrop-blur rounded-2xl shadow-lg p-6 border-2 border-[#c8a464]">
                        <div class="flex justify-between items-center border-b border-[#c8a464]/50 pb-4 mb-4">
                            <h3 class="text-lg font-bold text-[#3e2723] flex items-center gap-2 font-cinzel">
                                <i data-lucide="scroll" class="w-5 h-5 text-[#8c1c13]"></i> Diário de Bordo
                            </h3>
                            <button onclick="window.clearAllSessions()" class="text-xs text-red-800 hover:bg-red-100 px-3 py-1.5 rounded-md border border-red-300 transition flex items-center gap-1 font-bold">
                                <i data-lucide="trash-2" class="w-3 h-3"></i> Queimar Tudo
                            </button>
                        </div>
                        <ul id="history-list" class="space-y-3"></ul> 
                    </div>
                </div>`;
            lucide.createIcons();
            loadAndDisplaySessions();
        }

        function renderIsland(emotionKey) {
            currentPage = 'island';
            currentEmotion = emotionKey;
            const emotion = EMOTIONS[emotionKey];
            document.getElementById('content').innerHTML = `
                <div class="glass-panel p-6 sm:p-8 rounded-2xl shadow-2xl animate-fade-in max-w-3xl mx-auto relative">
                    <button onclick="window.renderMap()" class="absolute top-6 right-6 text-[#5d4037] hover:text-[#3e2723] transition">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                    <div class="flex items-center gap-3 mb-6">
                        <div class="p-3 rounded-full ${emotion.color.split(' ')[0]} text-white shadow-md border-2 border-white">
                            <i data-lucide="${emotion.icon}" class="w-8 h-8"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-[#3e2723] font-cinzel">${emotion.name}</h2>
                            <p class="text-sm text-[#5d4037] font-serif">Registro do Capitão</p>
                        </div>
                    </div>
                    <form id="emotion-form" onsubmit="event.preventDefault(); window.saveSession()">
                        <div class="space-y-5">
                            ${emotion.questions.map(q => `
                                <div class="bg-[#fff8e1] p-4 rounded-xl border-2 border-[#c8a464]/50 hover:border-[#c8a464] transition-colors">
                                    <label for="${q.id}" class="block text-sm font-bold text-[#3e2723] mb-2 flex items-center gap-2 font-cinzel">
                                        <i data-lucide="anchor" class="w-4 h-4 text-[#8c1c13]"></i> ${q.q}
                                    </label> 
                                    <textarea id="${q.id}" rows="3" class="w-full p-3 border border-[#c8a464] rounded-lg focus:ring-2 focus:ring-[#8c1c13] resize-none text-[#3e2723] bg-white" placeholder="Escreva aqui..."></textarea> 
                                </div>
                            `).join('')}
                        </div>
                        <div class="flex gap-3 mt-8">
                            <button type="button" onclick="window.renderMap()" class="flex-1 bg-[#5d4037] text-[#ffecb3] font-bold py-3 rounded-xl hover:bg-[#3e2723] transition font-cinzel border border-[#c8a464]">
                                Voltar ao Mar
                            </button>
                            <button type="submit" class="flex-[2] bg-[#8c1c13] text-white font-bold py-3 rounded-xl hover:bg-[#b71c1c] shadow-lg hover:shadow-red-900/30 transition flex items-center justify-center gap-2 font-cinzel border border-[#ffecb3]">
                                <i data-lucide="save" class="w-5 h-5"></i> Salvar no Log
                            </button>
                        </div>
                    </form>
                </div>`;
            lucide.createIcons();
        }

        function renderHistory(sessions) {
            const historyList = document.getElementById('history-list');
            if (!historyList) return;
            if (!sessions || sessions.length === 0) {
                historyList.innerHTML = `<li class="text-center py-8 text-[#8d6e63] italic text-sm bg-[#fff8e1] rounded-lg border border-dashed border-[#c8a464] font-serif">Nenhum registro encontrado no Log Pose.</li>`;
                return;
            }
            sessions.sort((a, b) => (new Date(b.timestamp).getTime()) - (new Date(a.timestamp).getTime()));
            historyList.innerHTML = sessions.map((session, index) => {
                const date = new Date(session.timestamp).toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', hour: '2-digit', minute: '2-digit' });
                const emotionColor = EMOTIONS[session.emotion]?.textColor.replace('text-', 'bg-').replace('700', '100') || 'bg-gray-100';
                const textColor = EMOTIONS[session.emotion]?.textColor || 'text-gray-700';
                const answersHtml = EMOTIONS[session.emotion]?.questions.map(q => `
                    <div class="mb-2">
                        <p class="text-xs font-bold text-[#5d4037] uppercase font-cinzel">${q.q}</p>
                        <p class="text-sm text-[#3e2723] bg-white p-2 rounded border border-[#c8a464]/30 font-serif">${session.answers[q.id] || '-'}</p>
                    </div>
                `).join('');
                return `
                    <li class="bg-[#fff8e1] rounded-xl p-4 border border-[#c8a464] hover:shadow-md transition">
                        <details class="group">
                            <summary class="flex items-center justify-between cursor-pointer list-none">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 rounded-lg bg-white border border-[#c8a464]">
                                        <i data-lucide="${EMOTIONS[session.emotion]?.icon || 'file-text'}" class="w-5 h-5 ${textColor}"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-[#3e2723] text-sm md:text-base font-cinzel">${session.emotionName.split('(')[0]}</h4>
                                        <p class="text-xs text-[#5d4037] font-serif">${date}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="window.exportHistoryEntryAsImage(${index})" class="text-xs bg-[#3e2723] text-[#ffecb3] hover:bg-[#5d4037] px-3 py-1.5 rounded-md transition flex items-center gap-1 border border-[#c8a464]" title="Baixar Imagem">
                                        <i data-lucide="download" class="w-3 h-3"></i> <span class="hidden sm:inline">Baixar</span>
                                    </button>
                                    <i data-lucide="chevron-down" class="w-4 h-4 text-[#5d4037] group-open:rotate-180 transition-transform"></i>
                                </div>
                            </summary>
                            <div class="mt-4 pl-2 border-l-2 border-[#c8a464] pt-2">
                                ${answersHtml}
                            </div>
                        </details>
                    </li>`;
            }).join('');
            lucide.createIcons();
        }
        
        window.clearAllSessions = function() {
            if (localSessions.length === 0) return;
            if (confirm(`Jogar todo o diário de ${selectedPatientName} ao mar?`)) {
                localStorage.removeItem(`localSessions_${selectedPatientName}`);
                localSessions = [];
                renderMap();
            }
        }

        window.generateSessionHtmlForExport = function(session) {
            const emotion = EMOTIONS[session.emotion];
            if (!emotion) return '';
            const answersHtml = emotion.questions.map(q => `
                <div class="mb-4 p-4 bg-[#fff8e1] rounded-lg border-l-4 ${emotion.color.split(' ')[0]} border-[#c8a464]">
                    <h3 class="text-sm font-bold text-[#3e2723] uppercase mb-1 font-cinzel">${q.q}</h3> 
                    <p class="text-[#4a2c2a] font-medium font-serif">${session.answers[q.id] || 'Sem resposta.'}</p> 
                </div>
            `).join('');
            
            return `
                <div class="p-10 bg-[url('https://www.transparenttextures.com/patterns/wood-pattern.png')] bg-[#fff3e0] rounded-xl border-8 border-[#3e2723]" style="width: 800px; font-family: 'Lora', serif;">
                    <div class="flex justify-between items-center border-b-2 border-[#3e2723]/20 pb-6 mb-6">
                        <h2 class="text-3xl font-bold flex items-center ${emotion.textColor} font-cinzel">
                            ${emotion.name}
                        </h2>
                        <div class="text-right">
                            <p class="text-[#5d4037] text-sm uppercase tracking-widest">Navegador</p>
                            <p class="text-xl font-bold text-[#3e2723] font-cinzel">${session.patientName}</p>
                        </div>
                    </div>
                    <div class="space-y-2">
                        ${answersHtml}
                    </div>
                    <div class="mt-8 pt-6 border-t border-[#3e2723]/20 flex justify-between items-center text-[#5d4037] text-sm italic">
                        <p>Grande Rota das Emoções - Gabriel o Psicólogo</p>
                        <p>${new Date(session.timestamp).toLocaleString('pt-BR')}</p>
                    </div>
                </div>
            `;
        }
        
        window.exportHistoryEntryAsImage = async function(sessionIndex) {
            const session = localSessions[sessionIndex];
            if (!session) return;
            displayMessage('Desenhando mapa...', 'bg-[#3e2723]');
            
            const exportContainer = document.getElementById('image-export-container');
            exportContainer.innerHTML = window.generateSessionHtmlForExport(session);
            
            try {
                const canvas = await html2canvas(exportContainer.firstElementChild, { scale: 2, backgroundColor: '#fff3e0' });
                const link = document.createElement('a');
                link.download = `LogPose_${session.patientName}_${session.emotion}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (error) {
                console.error(error);
                displayMessage('Erro no cartógrafo.', 'bg-red-700');
            } finally {
                exportContainer.innerHTML = '';
            }
        }

        window.showInstructionsModal = () => document.getElementById('instructionsModal').classList.remove('hidden');
        window.hideInstructionsModal = () => document.getElementById('instructionsModal').classList.add('hidden');

        window.renderMap = renderMap;
        window.selectEmotion = renderIsland;
        window.sailToIsland = sailToIsland; // Exportando a função de navegar
        window.saveSession = saveSession;
        window.renderPatientSelector = renderPatientSelector; 
        window.setPatient = setPatient;

        window.onload = () => lucide.createIcons();
    </script>
</body>
</html>